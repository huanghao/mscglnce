<meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />

<script src='jquery-1.4.2.min.js'></script>
<script src='backends.js'></script>

<script>
function Engine(tabid, request, backends) {
    this.tabid = tabid;
    this.sendback = request.sendback;
    this.request = self.request;
    this.backends = [];
    for (var i in backends)
        this.backends.push(new backends[i](request.meta));
}

Engine.prototype.next_backend = function() {
    this.backend_i += 1;
    this.backend_url_i = 0;
}

Engine.prototype.next_backend_url = function() {
    this.backend_url_i += 1;
    if (this.backend_url_i >= this.backends[this.backend_i].urls.length)
        this.next_backend()
}

Engine.prototype.search = function() {
    this.backend_i = 0;
    this.backend_url_i = 0;
    this._search()
}


Engine.prototype._search = function() {
    if (this.backend_i >= this.backends.length)
        return;

    var backend = this.backends[this.backend_i];
    var url = backend.urls[this.backend_url_i];
    self = this;
    
    var xhr = new XMLHttpRequest();
    xhr.open("GET", url, true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState == 4 && xhr.status == 200) {
            var albums = backend.parse(xhr.responseText);
            if (albums.length > 0) {
                self.next_backend();
                chrome.tabs.sendRequest(self.tabid, {
                    sendback: self.sendback,
                    title: backend.title,
                    url: url,
                    albums: albums
                 });
            }
            else {
                self.next_backend_url();
            }
            setTimeout("self._search()", 500);
        }
    };
    console.debug("SEARCH:"+url);
    xhr.send();
}

chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
    var backends = [GCN, XiaMi, Ting];
    (new Engine(sender.tab.id, request, backends)).search();
    sendResponse({});
});
</script>
